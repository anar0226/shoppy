name: ğŸ” Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  FLUTTER_VERSION: '3.27.4'

jobs:
  # =====================================
  # FAST PR CHECKS
  # =====================================
  pr-validation:
    name: ğŸš€ PR Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Get Dependencies
        run: flutter pub get

      - name: ğŸ” Static Analysis
        run: flutter analyze --fatal-infos

      - name: ğŸ¨ Format Check
        run: dart format --set-exit-if-changed .

      - name: ğŸ§ª Quick Tests
        run: flutter test --reporter=compact

  # =====================================
  # BUILD VERIFICATION
  # =====================================
  build-verification:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: pr-validation
    
    strategy:
      matrix:
        platform: [android, web]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Get Dependencies
        run: flutter pub get

      - name: ğŸ—ï¸ Build for Android
        if: matrix.platform == 'android'
        run: flutter build apk --debug

      - name: ğŸ—ï¸ Build for Web
        if: matrix.platform == 'web'
        run: flutter build web --debug

  # =====================================
  # PR FEEDBACK
  # =====================================
  pr-feedback:
    name: ğŸ“ PR Feedback
    runs-on: ubuntu-latest
    if: always()
    needs: [pr-validation, build-verification]
    
    steps:
      - name: ğŸ“Š Comment on PR (Success)
        if: ${{ success() }}
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **PR Validation Passed!** ğŸ‰\n\n' +
                    '- âœ… Code analysis passed\n' +
                    '- âœ… Formatting is correct\n' +
                    '- âœ… Tests are passing\n' +
                    '- âœ… Builds successfully\n\n' +
                    'Ready for review! ğŸš€'
            })

      - name: ğŸ“Š Comment on PR (Failure)
        if: ${{ failure() }}
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **PR Validation Failed!** ğŸ”¥\n\n' +
                    'Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ' +
                    'and fix the issues before requesting a review.\n\n' +
                    'Common issues:\n' +
                    '- Code formatting (`dart format .`)\n' +
                    '- Analysis issues (`flutter analyze`)\n' +
                    '- Test failures (`flutter test`)\n' +
                    '- Build errors'
            }) 